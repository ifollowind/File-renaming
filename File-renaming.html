<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šæ–‡ä»¶é‡å‘½åå·¥å…·</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 2rem;
        }

        /* ä¸»å®¹å™¨ */
       .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ‹–æ‹½åŒºåŸŸ */
       .drop-zone {
            background: #f8f9fa;
            padding: 3rem 2rem;
            text-align: center;
            border-bottom: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

       .drop-zone.drag-over {
            background: #f0f6ff;
            border-color: #007bff;
        }

        /* æ“ä½œæŒ‰é’® */
       .action-btn {
            background: #007bff;
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 2rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

       .action-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        /* è§„åˆ™é€‰é¡¹å¡ */
       .rule-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: #f8f9fa;
            border-bottom: 2px solid #e4e7ec;
        }

       .tab-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: #6c757d;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

       .tab-btn.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 6px rgba(0,123,255,0.2);
        }

        /* è§„åˆ™é¢æ¿ */
       .rule-panels {
            padding: 2rem;
        }

       .rule-panel {
            display: none;
            animation: fadeIn 0.3s ease;
            min-height: 180px;
        }

       .rule-panel.active {
            display: block;
        }
        /* æ“ä½œå·¥å…·æ  */
        .action-toolbar {
            padding: 1rem 2rem;
            background: #f8f9fa;
            border-top: 1px solid #e4e7ec;
            display: flex;
            gap: 1rem;
        }
        /* æ—¥å¿—åŒºåŸŸ */
       .log-panel {
            background: #f8f9fa;
            padding: 2rem;
            border-top: 2px solid #e4e7ec;
            max-height: 400px;
            overflow-y: auto;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
       .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin: 1rem 0;
            transition: border-color 0.3s;
        }

       .form-control:focus {
            border-color: #007bff;
            outline: none;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* è¡¨å¤´æ ·å¼ */
        #fileListTable thead th {
            background-color: hsl(207, 9%, 75%);
            color: white;
            font-weight: bold;
            padding: 0.8rem; /* ç»Ÿä¸€å·¦å³è¾¹è· */
            text-align: center;
        }

        /* è¡¨æ ¼å†…å®¹æ ·å¼ */
        #fileListTable tbody td {
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid #dee2e6;
            text-align: center; /* ç¡®ä¿æ–‡æœ¬å±…ä¸­æ˜¾ç¤º */
        }

        /* ä¸ºè¡¨å¤´çš„æ¯ä¸ª <th> å…ƒç´ æ·»åŠ å›ºå®šçš„å®½åº¦ */
        #fileListTable thead th:nth-child(1) { width: 60px; }
        #fileListTable thead th:nth-child(2) { width: 400px; }
        #fileListTable thead th:nth-child(3) { width: 400px; }
        #fileListTable thead th:nth-child(4) { width: 100px; }
        #fileListTable thead th:nth-child(5) { width: 150px; }

    </style>
</head>
<body>
    <div class="main-container">
        <!-- æ‹–æ‹½åŒºåŸŸ -->
        <div class="drop-zone" id="dropArea">
            <button class="action-btn" id="openFolder">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 5a2 2 0 012-2h5.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H19a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/>
                </svg>
                æ‰“å¼€æ–‡ä»¶å¤¹
            </button>
            <p style="color: #6c757d; margin-top: 1rem;">
                ç‚¹å‡»æŒ‰é’®æ‰“å¼€æ–‡ä»¶å¤¹ï¼Œæˆ–å°†æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤å¤„<br>
                <small>æ”¯æŒæ‰€æœ‰æ–‡ä»¶æ ¼å¼ï¼Œä¸é™æ–‡ä»¶å¤§å°</small>
            </p>
        </div>

        <!-- è§„åˆ™é€‰é¡¹å¡ -->
        <div class="rule-tabs">
            <button class="tab-btn active" data-rule="prefix">å‰ç¼€è§„åˆ™</button>
            <button class="tab-btn" data-rule="suffix">åç¼€è§„åˆ™</button>
            <button class="tab-btn" data-rule="replace">å­—ç¬¦æ›¿æ¢</button>
            <button class="tab-btn" data-rule="custom">è‡ªå®šä¹‰æ¨¡æ¿</button>
            <button class="tab-btn" data-rule="identifier">æ™ºèƒ½æ ‡è¯†</button>
        </div>

        <!-- è§„åˆ™é¢æ¿å®¹å™¨ -->
        <div class="rule-panels">
            <!-- å‰ç¼€è§„åˆ™ -->
            <div class="rule-panel active" data-panel="prefix">
                <input type="text" class="form-control" placeholder="è¾“å…¥å‰ç¼€æ–‡å­—...">
                <div style="margin-top: 1rem;">
                    <label><input type="checkbox" checked> è‡ªåŠ¨æ·»åŠ åˆ†éš”ç¬¦ "_"</label>
                </div>
            </div>

            <!-- åç¼€è§„åˆ™ -->
            <div class="rule-panel" data-panel="suffix">
                <input type="text" class="form-control" placeholder="è¾“å…¥åç¼€æ–‡å­—...">
                <div style="margin-top: 1rem;">
                    <label><input type="checkbox"> ä¿ç•™åŸå§‹æ‰©å±•å</label>
                </div>
            </div>

            <!-- å­—ç¬¦æ›¿æ¢è§„åˆ™ -->
            <div class="rule-panel" data-panel="replace">
                <input type="text" class="form-control" placeholder="æŸ¥æ‰¾å†…å®¹...">
                <input type="text" class="form-control" placeholder="æ›¿æ¢å†…å®¹...">
            </div>

            <!-- è‡ªå®šä¹‰æ¨¡æ¿è§„åˆ™ -->
            <div class="rule-panel" data-panel="custom">
                <input type="text" class="form-control" placeholder="åºå·ï¼š{num}/{num2}/{num3}ï¼› åŸå§‹æ–‡ä»¶åï¼š{name}">
            </div>

            <!-- æ™ºèƒ½æ ‡è¯†è§„åˆ™ -->
            <div class="rule-panel" data-panel="identifier">
                <textarea class="form-control" placeholder="æ¯è¡Œæ ¼å¼ï¼šæ ‡è¯†ç¬¦[ç©ºæ ¼/åˆ¶è¡¨ç¬¦]æ–°æ–‡æœ¬
ç¤ºä¾‹ï¼š
15279   é”€å”®å‘ç¥¨
XJ2023  å¹´åº¦æŠ¥å‘Š" style="height: 80px;"></textarea>
                <div style="margin-top: 1rem;">
                    <label><input type="checkbox" checked> åŠ å‰ç¼€ï¼ˆä½¿ç”¨_è¿æ¥ï¼‰</label>
                    <label><input type="checkbox"> å®Œå…¨æ›¿æ¢ï¼ˆè‡ªåŠ¨å¤„ç†é‡å¤ï¼‰</label>
                    <label><input type="checkbox"> åŠ åç¼€ï¼ˆä½¿ç”¨_è¿æ¥ï¼‰</label>
                </div>
            </div>
        </div>

        <!-- æ–°å¢çš„æ“ä½œå·¥å…·æ  -->
        <div class="action-toolbar">
            <button class="action-btn" id="previewBtn">ğŸ‘ï¸ é¢„è§ˆæ•ˆæœ</button>
            <button class="action-btn" id="executeBtn" style="background: #28a745;">ğŸš€ æ‰§è¡Œé‡å‘½å</button>
            <button class="action-btn" id="downloadZipBtn">ğŸ“¦ æ‰“åŒ…ä¸‹è½½</button>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-panel">
            <h3 style="margin-bottom: 1rem;">æ“ä½œæ—¥å¿—</h3>
            <table id="fileListTable">
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>æ–‡ä»¶åç§°</th>
                        <th>æ–°æ–‡ä»¶åç§°</th>
                        <th>æ–‡ä»¶å¤§å°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // ç³»ç»ŸçŠ¶æ€ç®¡ç†
        const state = {
            dirHandle: null,
            fileHandles: [],
            renameRules: { type: 'prefix', params: {} },
            usedNames: new Map()
        };
        // ç”Ÿæˆå½“å‰çš„æ—¥æœŸå’Œæ—¶é—´å­—ç¬¦ä¸²
        function getDateTimeString() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
          return `${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}`;
        }



        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function () {
            // æ‰“å¼€æ–‡ä»¶å¤¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('openFolder').addEventListener('click', openFolder);

            // æ‹–æ‹½åŒºåŸŸäº‹ä»¶ç›‘å¬
            const dropArea = document.getElementById('dropArea');
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('drag-over');
            });
            dropArea.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                const items = e.dataTransfer.items;
                for (const item of items) {
                    if (item.kind === 'file' && item.webkitGetAsEntry().isDirectory) {
                        try {
                            state.dirHandle = await item.getAsFileSystemHandle();
                            await traverseDirectory(state.dirHandle);
                            displayFileList();
                        } catch (error) {
                            handleError(error);
                        }
                    }
                }
            });

            // è§„åˆ™é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function () {
                    // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
                    const ruleType = this.dataset.rule;
                    document.querySelectorAll('.rule-panel').forEach(panel => {
                        panel.classList.toggle('active', panel.dataset.panel === ruleType);
                    });

                    // æ›´æ–°å…¨å±€è§„åˆ™ç±»å‹
                    state.renameRules.type = ruleType;
                });
            });

            // åˆå§‹åŒ–é»˜è®¤æ¿€æ´»çš„è§„åˆ™é€‰é¡¹å¡å’Œé¢æ¿
            const defaultRule = 'identifier'; // è®¾ç½®é»˜è®¤æ¿€æ´»çš„è§„åˆ™
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.rule-panel').forEach(panel => panel.classList.remove('active'));

            const defaultTab = document.querySelector(`.tab-btn[data-rule="${defaultRule}"]`);
            const defaultPanel = document.querySelector(`.rule-panel[data-panel="${defaultRule}"]`);

            if (defaultTab && defaultPanel) {
                defaultTab.classList.add('active');
                defaultPanel.classList.add('active');
            } else {
                // å¦‚æœé»˜è®¤è§„åˆ™ä¸å­˜åœ¨ï¼Œåˆ™ä¸æ¿€æ´»ä»»ä½•é€‰é¡¹å¡å’Œé¢æ¿
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.rule-panel').forEach(panel => panel.classList.remove('active'));
            }

            // æ–°å¢æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('previewBtn').addEventListener('click', previewRename);
            document.getElementById('executeBtn').addEventListener('click', executeRename);
        });



        // æ‰“å¼€æ–‡ä»¶å¤¹æ ¸å¿ƒé€»è¾‘
        async function openFolder() {
            try {
                // ç°ä»£æµè§ˆå™¨æ–¹æ¡ˆ
                if (!('showDirectoryPicker' in window)) throw new Error('è¯·ä½¿ç”¨Chrome 86+æˆ–Edge 88+');
                state.dirHandle = await window.showDirectoryPicker();
                await traverseDirectory(state.dirHandle);
                displayFileList();
            } catch (error) {
                handleError(error);
            }
        }

        // é€’å½’éå†ç›®å½•
        async function traverseDirectory(dirHandle) {
            state.fileHandles = [];
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    state.fileHandles.push({
                        handle: entry,
                        originalName: entry.name,
                        newName: null
                    });
                }
            }
        }

        // æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        async function displayFileList() {
            const tableBody = document.querySelector('#fileListTable tbody');
            tableBody.innerHTML = '';

            for (const [index, f] of state.fileHandles.entries()) {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = f.originalName;
                row.insertCell(2).textContent = f.newName || '';
                const fileSize = await getFileSize(f.handle); // ç­‰å¾… Promise è§£æ
                row.insertCell(3).textContent = fileSize;
                const actionCell = row.insertCell(4);
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'ä¸‹è½½';
                downloadBtn.addEventListener('click', () => downloadFile(f));
                actionCell.appendChild(downloadBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.addEventListener('click', () => deleteFile(f));
                actionCell.appendChild(deleteBtn);
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(file) {
            // åˆ›å»ºä¸€ä¸ª Blob URL
            file.handle.getFile().then(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = file.newName || file.originalName; // è®¾ç½®ä¸‹è½½çš„æ–‡ä»¶å
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // é‡Šæ”¾ Blob URL
            }).catch(error => {
                handleError(error);
            });
        }

        // åˆ é™¤æ–‡ä»¶
        function deleteFile(file) {
            // å®ç°åˆ é™¤é€»è¾‘
            // ä¾‹å¦‚ï¼Œä» state.fileHandles ä¸­ç§»é™¤æ–‡ä»¶ï¼Œå¹¶æ›´æ–°æ˜¾ç¤º
            state.fileHandles = state.fileHandles.filter(f => f !== file);
            displayFileList();
        }
        // æ ¸å¿ƒé‡å‘½åé€»è¾‘
        function generateNewName(originalName, index, rule) {
            const ext = originalName.slice(originalName.lastIndexOf('.'));
            const baseName = originalName.slice(0, originalName.lastIndexOf('.'));

            switch (rule.type) {
                case 'prefix':
                    return `${rule.params.prefix}${rule.params.separator || ''}${baseName}${ext}`;
                case 'suffix':
                    return `${baseName}${rule.params.suffix}${ext}`;
                case 'replace':
                    const newBase = baseName.replace(
                        new RegExp(rule.params.search, 'g'),
                        rule.params.replace
                    );
                    return `${newBase}${ext}`;
                case 'custom':
                    return rule.params.pattern
                       .replace(/{num}/g, index + 1)
                       .replace(/{num2}/g, (index + 1).toString().padStart(2, '0'))
                       .replace(/{num3}/g, (index + 1).toString().padStart(3, '0'))
                       .replace(/{name}/g, baseName)
                        + ext;
                case 'identifier':
                    return applyIdentifierRule(baseName, ext, rule.params);
                default:
                    return originalName;
            }
        }

        // æ ‡è¯†æ›¿æ¢è§„åˆ™å®ç°
        function applyIdentifierRule(baseName, ext, params) {
            const rules = parseReplaceRules(params.rules);
            const match = findFirstMatch(baseName, rules);

            if (!match) return baseName + ext;

            const [identifier, newText] = match;
            const isReplace = params.replace;
            const isPrefix = params.prefix;
            const isSuffix = params.suffix;

            if (!isReplace && !isPrefix && !isSuffix) {
                throw new Error('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ›¿æ¢æ¨¡å¼');
            }

            let newBase = baseName;
            if (isReplace) {
                newBase = handleReplaceMode(newText, ext);
            } else {
                if (isPrefix) newBase = `${newText}_${newBase}`;
                if (isSuffix) newBase = `${newBase}_${newText}`;
            }
            return newBase + ext;
        }

        // è§£æå¤šè¡Œè§„åˆ™
        function parseReplaceRules(text) {
            return text.split('\n')
               .filter(line => line.trim())
               .map(line => {
                    const [id,...parts] = line.trim().split(/\s+/);
                    return [id, parts.join(' ')];
                });
        }

        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ ‡è¯†ç¬¦
        function findFirstMatch(baseName, rules) {
            return rules.find(([id]) => baseName.includes(id));
        }

        // å¤„ç†å®Œå…¨æ›¿æ¢æ¨¡å¼
        const usedNames = new Map();
        function handleReplaceMode(newText, ext) {
            const key = newText + ext;
            let count = usedNames.get(key) || 0;
            count++;
            usedNames.set(key, count);
            return count > 1 ? `${newText}(${count})` : newText;
        }

        // é¢„è§ˆé‡å‘½åç»“æœ
        async function previewRename() {
            state.usedNames.clear();
            const rule = getCurrentRule();
            // æ¸…ç©ºæ—¥å¿—åŒºåŸŸ
            const logPanel = document.querySelector('.log-panel h3 + table + div');
            if (logPanel) {
                logPanel.textContent = '';
            }
            // æ·»åŠ æ—¥å¿—
            addLog('å½“å‰è§„åˆ™ç±»å‹: ' + rule.type);
            addLog('è§„åˆ™å‚æ•°: ' + JSON.stringify(rule.params));

            state.fileHandles.forEach((file, index) => {
                addLog('å¤„ç†æ–‡ä»¶: ' + file.originalName);
                try {
                    file.newName = generateNewName(file.originalName, index, rule);
                    addLog('ç”Ÿæˆçš„æ–°æ–‡ä»¶å: ' + file.newName);
                } catch (error) {
                    addLog('é”™è¯¯: ' + error.message);
                }
            });
            updatePreview();
            updateTable(); // è¿™è¡Œä»£ç æ¥æ›´æ–°è¡¨æ ¼
        }

        // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
        async function updateTable() {
            const tableBody = document.querySelector('#fileListTable tbody');
            tableBody.innerHTML = '';

            for (const [index, f] of state.fileHandles.entries()) {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = f.originalName;
                row.insertCell(2).textContent = f.newName || ''; // ç¡®ä¿æ–°çš„æ–‡ä»¶åç§°æ­£ç¡®å†™å…¥
                const fileSize = await getFileSize(f.handle); // ç­‰å¾… Promise è§£æ
                row.insertCell(3).textContent = fileSize;
                const actionCell = row.insertCell(4);
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'ä¸‹è½½';
                downloadBtn.addEventListener('click', () => downloadFile(f));
                actionCell.appendChild(downloadBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.addEventListener('click', () => deleteFile(f));
                actionCell.appendChild(deleteBtn);
            }
        }


        // æ·»åŠ æ—¥å¿—åˆ°æ—¥å¿—åŒºåŸŸ
        function addLog(message) {
            const logElement = document.getElementById('fileList');
            // ä½¿ç”¨æ­£ç¡®çš„æ—¥å¿—å…ƒç´  ID
            const logPanel = document.querySelector('.log-panel h3 + table + div');
            if (logPanel) {
                logPanel.textContent += message + '\n';
            }
        }

        // è·å–å½“å‰è§„åˆ™é…ç½®
        function getCurrentRule() {
            const activePanel = document.querySelector('.rule-panel.active');
            if (!activePanel) {
                throw new Error('æ²¡æœ‰æ¿€æ´»çš„è§„åˆ™é¢æ¿');
            }
            const type = activePanel.getAttribute('data-panel');
            let params = {};

            switch (type) {
                case 'prefix':
                    params.prefix = activePanel.querySelector('input[type="text"]').value;
                    params.separator = activePanel.querySelector('input[type="checkbox"]').checked ? '_' : '';
                    break;
                case 'suffix':
                    params.suffix = activePanel.querySelector('input[type="text"]').value;
                    params.keepExtension = activePanel.querySelector('input[type="checkbox"]').checked;
                    break;
                case 'replace':
                    params.search = activePanel.querySelectorAll('input[type="text"]')[0].value;
                    params.replace = activePanel.querySelectorAll('input[type="text"]')[1].value;
                    break;
                case 'custom':
                    params.pattern = activePanel.querySelector('input[type="text"]').value;
                    break;
                case 'identifier':
                    params.rules = activePanel.querySelector('textarea').value;
                    const checkboxes = activePanel.querySelectorAll('input[type="checkbox"]');
                    params.prefix = checkboxes[0].checked;
                    params.replace = checkboxes[1].checked;
                    params.suffix = checkboxes[2].checked;
                    // æ·»åŠ æ ¡éªŒ
                    if (!params.rules.trim()) {
                        throw new Error('è¯·å¡«å†™æ ‡è¯†ç¬¦æ›¿æ¢è§„åˆ™');
                    }
                    if (!params.prefix && !params.replace && !params.suffix) {
                        throw new Error('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ›¿æ¢æ¨¡å¼');
                    }
                    break;
            }

            return { type, params };
        }

        // æ›´æ–°é¢„è§ˆæ˜¾ç¤º
        function updatePreview() {
            const list = state.fileHandles.map(f =>
                f.newName ? `â— ${f.originalName} â†’ ${f.newName}` : `â— ${f.originalName}`
            ).join('\n');
            // ä½¿ç”¨æ­£ç¡®çš„æ—¥å¿—å…ƒç´ é€‰æ‹©å™¨
            const logPanel = document.querySelector('.log-panel h3 + table + div');
            if (logPanel) {
                logPanel.textContent = list;
            }
        }

        // æ‰§è¡Œé‡å‘½å
        async function executeRename() {
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨ç§»åŠ¨è®¾å¤‡ä¸Š
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    alert("æ‰‹æœºç«¯æ— æ³•æ‰§è¡Œé‡å‘½åï¼Œè¯·ç‚¹å‡»é¢„è§ˆï¼Œå†ç‚¹å‡»æ‰“åŒ…ä¸‹è½½ï¼Œå³å¯å°†é‡å‘½ååçš„æ–‡ä»¶ä¸‹è½½è‡³æ‰‹æœºä¸Š");
                    return;
                }

                let successCount = 0;
                for (const file of state.fileHandles) {
                    if (file.newName) {
                        await file.handle.move(file.newName);
                        successCount++;
                    }
                }
                alert(`æ“ä½œå®Œæˆï¼æˆåŠŸé‡å‘½å ${successCount} ä¸ªæ–‡ä»¶`);
                await traverseDirectory(state.dirHandle);
                displayFileList();
            } catch (error) {
                handleError(error);
            }
        }

        // æ‰“åŒ…ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('downloadZipBtn').addEventListener('click', async function () {
            try {
                const zip = new JSZip();

                for (const file of state.fileHandles) {
                    if (file.newName) {
                        const originalFile = await file.handle.getFile();
                        zip.file(file.newName, originalFile);
                    }
                }
                const dateTimeString = getDateTimeString();
                const fileName = `renamed_files_${dateTimeString}.zip`; // ä½¿ç”¨æ—¥æœŸæ—¶é—´ä½œä¸ºæ–‡ä»¶å
                const content = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(content);
                const link = document.createElement("a");
                link.href = url;
                link.download = fileName; // è®¾ç½®ä¸‹è½½çš„æ–‡ä»¶å
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                handleError(error);
            }
        });


        // é”™è¯¯å¤„ç†
        function handleError(error) {
            console.error(error);
            alert(`é”™è¯¯: ${error.message}`);
        }

        // æ–°å¢ï¼šè·å–æ–‡ä»¶å¤§å°çš„å‡½æ•°
        async function getFileSize(fileHandle) {
            const file = await fileHandle.getFile();
            return formatSize(file.size);
        }

        // æ–°å¢ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°çš„å‡½æ•°
        function formatSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }
    </script>
</body>
</html>